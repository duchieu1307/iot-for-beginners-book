== HTTP Client

=== Giao thức HTTP
`HTTP` - Hypertext Transfer Protocol (giao thức truyền dẫn siêu văn bản), là giao thức để truyền dữ liệu giữa các máy tính qua `www` (World Wide Web), với dữ liệu có thể là dạng text, file, ảnh, hoặc video.

HTTP được thiết kế để trao đổi dữ liệu giữa Client và Server trên nền TCP/IP, nó vận hành theo cơ chế `yêu cầu/trả lời`, `stateless - không lưu trữ trạng thái`. Trình duyệt Web chính là Client, và một máy chủ chứa Web Site là Server. Client sẽ kết nối tới Server, gởi dữ liệu đến server bao gồm các thông tin header. Server nhận được thông tin và căn cứ trên đó gởi phản hồi lại cho Client. Đồng thời đóng kết nối.

Một ví dụ điển hình là khi bạn gõ địa chỉ vào thanh địa chỉ của trình duyệt và nhấn `Enter`, thì ngay lập tức Web Client sẽ thực hiện việc gởi yêu cầu tới Web Server có địa chỉ mà bạn vừa gõ. Web Server sẽ trả lời bằng nội dung Web Site mà bạn cần xem.

Trong giao thức HTTP, việc thiết lập kết nối chỉ có thể xuất phát từ phía client ( lúc này có thể gọi là HTTP Client ). Khi client gữi yêu cầu, cùng với *URL* và payload ( dữ liệu muốn lấy ) tới server. Server ( HTTP Server ) lắng nghe mọi yêu cầu từ phía client và trả lời các yêu cầu ấy, và khi trả lời xong kết nối được chấm dứt.


.Cách thức HTTP hoạt động
image::03-wifi/http1-req-res-details.png[Cách thức HTTP hoạt động, role="center", align="center", width=400]

Khi nhắc tới HTTP thì Hyperlink, hay URL (Uniform Resource Locator) là những khái niệm được thấy hàng ngày

*URL* được dùng để định dạng địa chỉ Website, chưa các thông tin yêu cầu từ client và server dựa vào đó xử lý, cấu trúc của nó như hình
.Cấu trúc 1 URL
image::03-wifi/http1-url-structure.png[URL, role="center", align="center", width=400]

Ví dụ bạn có thể gởi thông tin về nhiệt độ đến server thông qua đường dẫn: `http://esp8266.vn/log.php?nhiet_do=30`

.Cấu trúc 1 URL
[source]
....

|scheme  | host      |port |path            |query                |fragment|
 http:// server.com: 8080  /path/to/log.php ?nhiet_do=30&do_am=80 #test
....
<1> `scheme` xác định giao thức truyền tới server, nếu là `https` thì sẽ được mã hóa
<2> `host` địa chỉ server
<3> `port` port server dùng để phục vụ, nếu ko có thì mặc định là `80` cho web
<4> `path` thông tin client muốn truy suất
<5> `query` thông tin client muốn gởi lên
<6> `fragment` thuộc tính này giúp browser đi đến vị trí của trang

Với đường dẫn như trên, khi bạn gõ vào trình duyệt, thì quá browser sẽ thực hiện kết nối và gởi dữ liệu như sau. Bạn có thể sử dụng curl để xem chi tiết dữ liệu raw truyền nhận `curl -v http://esp8266.vn/log.php?nhiet_do=30`

----
GET /log.php?nhiet_do=30 HTTP/1.1
Host: esp8266.vn
User-Agent: curl/7.49.1
Accept: */*

----

Dữ liệu trả về

----
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Transfer-Encoding: chunked
Connection: keep-alive

data
----

==== Giao thức HTTP định nghĩa một số phương thức (method) truyền đến Server:

* `GET` là phương thức *request* đơn giản và thường sử dụng nhất của HTTP. Request *GET* là yêu cầu server chỉ trả về dữ liệu mà không có tác động nào tới server. GET sử dụng `path` và `query` trong *URL* để thông báo cho Server thông tin cần lấy.
* `POST` tương tự như `GET`, nhưng `POST` có thể gởi dữ liệu về Server
* `PUT` là phương thức yêu cầu tạo mới một dữ liệu, giống `POST` nhưng đánh dấu cho Server biết, nếu dữ liệu không tồn tại trong cơ sở dữ liệu thì tạo mới, hoặc sửa đổi nó.
* `DELETE` Tương tự như `GET`, nhưng báo cho Server biết về việc xóa dữ liệu thông qua URL

Các phương thức thông thường chỉ dùng `GET` và `POST`, các phương thức còn lại thường sử dụng trong API server (RESTful). Một số điểm khác biệt giữ `POST` và `GET`

* `GET` có thể bị cache (lưu trữ ở trình duyệt và sử dụng lại sau đó), nội dung request có thể lưu trữ ở lịch sử trình duyệt, có thể được đánh dấu (bookmark)
* `GET` không nên sử dụng để gởi các dữ liệu nhạy cảm
* `GET` bị giới hạn độ lớn dữ liệu cần gởi
* `GET` chỉ nên dùng để lấy dữ liệu về

* `POST` không bị catch, không tồn tại dữ liệu gởi trong lịch sử trình duyệt, không thể đánh dấu (bookmark)
* `POST` không giới hạn bởi độ lớn dữ liệu cần gởi

==== HTTP Header & Status Code

Dữ liệu trả về bao giờ cũng có phần thông tin header với dòng đầu tiên chưa Status Code `HTTP/1.1 200 OK` có nghĩa là status code = 200, request được trả về phù hợp.
Theo sau đó là các cặp header chứa thông tin Server muốn trao đổi với Client, mà nếu là trình duyệt thì nó bị ẩn đi (người dùng bình thường không thể thấy). Các cặp header này định dạng theo kiểu `name: value` và kết thúc bằng ký tự xuống dòng không thấy bằng mắt thường (`0x0D 0x0A` hay `\r\n`)
Trong ví dụ trên, thông tin header `Content-Type: text/html; charset=utf-8` báo cho trình duyệt biết rằng định dạng dữ liệu gởi về là dạng text, mã hóa utf-8. `Transfer-Encoding: chunked` chiều dài dữ liệu không được biết trước và gởi cho tới khi server đóng kết nối.

Một số HTTP status code thường thấy:

* *1xx*: Dãy mã này được quy định trong *HTTP/1.1*. Server có thể gữi một message với nội dung **Expect: 100-continue**, yêu cầu client tiếp tục gữi phần còn lại của *request* hoặc bỏ qua nếu client đã gữi.Với client *HTTP/1.0* thì có thể không quan tâm header này.
* **2xx**: Xử lý thành công, thông báo với client rằng request đã được xử lý thành công. Với mã phổ biến là **200 OK**. Đối với một *GET* request, server sẽ gữi tài nguyên trong phần thân của message. Cón những mã khác ít dùng hơn
** *201 Created*: cho biết request đã xử lý thành công và tài nguyên đã được khởi tạo. Được sử dụng để xác nhận sự thành công của một request *PUT* hoặc *POST*.
** *202 Accepted*: Yêu cầu đã được chấp nhận, nhưng có thể tài nguyên không có trong response. Thông điệp này rất hữu ích cho xử lý async phía server. Server có thể chọn gữi thông tin để theo dõi.
** *204 No Content*: thông báo không có phần thân message trong response.
** *205 Reset Content*: thông báo cho client reset lại chế độ xem tài liệu.
** *206 Partial Content*: Nói rằng response chỉ chứa một phần nội dung.
* *4xx* các thông báo lỗi phía client: Được sử dụng khi server cho rằng phía client đang xảy ra lỗi, với một request một tài nguyên không hợp lệ hoặc là một request không đúng. Mã phổ biến nhất trong phần này là **404 Not Found** chỉ ra rằng tài nguyên không hợp lệ và tồn tại trên server. Ngoài ra còn có một số mã như sau :
** *400 Bad Request*: thông báo request đã gữi là sai.
** *401 Unauthorized*: chỉ ra rằng request cần được xác thực. Client có thể gữi lại request với header đã được xác thực. Trường hợp đã đính kèm header xác thực nhưng vẫn nhận được thông báo này tức là header xác thực chưa hợp lệ.
** *403 Forbidden*: server từ chối quyền truy cập của client.
** *404 Not Found*: Không tồn tại nội dung yêu cầu trên Server.
** *405 Method Not Allowed*: HTTP verb trong các dòng request không hợp lệ, hoặc server không hổ trợ HTTP verb đó.
** *409 Conflict*: server không thể hoàn thành yêu cầu vì client cố chỉnh sửa tài nguyên mới hơn so với *timestamp* của client. Xung đột xảy ra chủ yếu trong các request *PUT*  trong quá trình hợp tác chỉnh sửa tài nguyên.
* *5xx*: thông báo lỗi phía server: Được sử dụng để nói rằng server thất bại trong quá trình xử lý request. Với mà lỗi thông dụng nhất là **500 Internal Server Eror**, và một số mã khác :
** *501 Not Implemented*: thông báo server chưa hổ trợ chức năng mà client đã request.
** *503 Service Unavailable*: Xảy ra khi hệ thống nội bộ của server đã thất bại hoặc quá tải.

=== JSON

JSON (JavaScript Object Noattion) là 1 định dạng hoán vị dữ liệu nhanh. Chúng dễ dàng cho chúng ta đọc và viết. Dễ dàng cho thiết bị phân tích và phát sinh. Chúng là cơ sở dựa trên tập hợp của Ngôn Ngữ Lập Trình JavaScript. JSON là 1 định dạng kiểu text mà hoàn toàn độc lập với các ngôn ngữ hoàn chỉnh, thuộc họ hàng với các ngôn ngữ họ hàng C, gồm có C, C++, C#, Java, JavaScript, Perl, Python, và nhiều ngôn ngữ khác. Những đặc tính đó đã tạo nên JSON 1 ngôn ngữ hoán vị dữ liệu lý tưởng.

JSON được xây dựng trên 2 cấu trúc:

Là tập hợp của các cặp tên và giá trị name-value. Trong những ngôn ngữ khác nhau, đây được nhận thấy như là 1 đối tượng (object), sự ghi (record), cấu trúc (struct), từ điển (dictionary), bảng băm (hash table), danh sách khoá (keyed list), hay mảng liên hợp.
Là 1 tập hợp các giá trị đã được sắp xếp. Trong hầu hết các ngôn ngữ, this được nhận thấy như là 1 mảng, véc tơ, tập hợp hay là 1 dãy sequence.
Đây là 1 cấu trúc dữ liệu phổ dụng. Hầu như tất cả các ngôn ngữ lập trình hiện đại đều hổ trợ chúng trong 1 hình thức nào đó. Chúng tạo nên ý nghĩa của 1 định dạng hoán vị dữ liệu với các ngôn ngữ lập trình cũng đã được cơ sở hoá trên cấu trúc này.

**Cú pháp**

* Dữ liệu nằm trong các cặp name/value
* Các dữ liệu được ngăn cách bởi dấy phẩy `,`
* Các đối tượng (name/value) nằm giữa hai dấu ngoặc kép `"`
* Tất cả các đối tượng nằm bên trong hai dấu ngoặc nhọn `{}`
* Dữ liệu của JSON được viết theo từng cặp name/value. Một cặp name/value bao gồm trường `name` ( nằm trong hai dấu ngoặc kép `"`, theo sau là dấu hai chấm `:`, và sau cùng là trường `value` (cũng được nằm trong hai dấu ngoặc kép `"`. Ví dụ: `"name":"John"`

[source, json]
----
{
    "username" : "your-user-name",
    "email" : "your-email@email.com",
    "website" : "iota.edu.vn",
    "title" : "IoT Stater Cource"
}
----

=== Ứng dụng xem giá Bitcoin

Một ứng dụng đơn giản sử dụng giao thức HTTP để lấy tỉ giá Bitcoin (BTC)/USD từ các trang Web giao dịch, hiển thị lên màn hình OLED.

Chúng ta có rất nhiều nguồn lấy tỉ giá, một trong số đó là https://coinmarketcap.com/api/. Với tài liệu được cung cấp, và nhu cầu là chỉ lấy tỉ giá Bitcoin/USD, chúng ta chỉ cần ESP8266 gởi 1 HTTP Request đến https://api.coinmarketcap.com/v1/ticker/bitcoin/ thì sẽ nhận được một chuỗi JSON dạng như:

[source, json]
----
[
    {
        "id": "bitcoin",
        "name": "Bitcoin",
        "symbol": "BTC",
        "rank": "1",
        "price_usd": "4121.82",
        "price_btc": "1.0",
        "24h_volume_usd": "2070600000.0",
        "market_cap_usd": "68082264895.0",
        "available_supply": "16517525.0",
        "total_supply": "16517525.0",
        "percent_change_1h": "0.38",
        "percent_change_24h": "0.97",
        "percent_change_7d": "2.28",
        "last_updated": "1503240569"
    }
]
----

và giá trị của trường `price_usd` chính là giá trị chúng ta muốn hiển thị.

NOTE: Đa số các dịch vụ Web hiện nay đều sử dụng giao thức bảo mật `HTTPS`, cũng là HTTP, nhưng quá trình truyền nhận được mã hóa dữ liệu, thực hiện xác thực trước khi gửi giữa Client và Server.
