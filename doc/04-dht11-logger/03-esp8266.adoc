== Code ESP8266

ESP8266 sử dụng thư viện HTTPClient để kết nối tới Web Server và dữ liệu nhiệt độ, đổ ẩm thông qua phương thức GET với query là `temp` và `humd`.

=== Chuẩn bị
- Cung cấp SSID và PASSWORD WiFi cho board mạch ESP8266 để kết nối vào mạng nội bộ với Web Server.
- Cung cấp địa chỉ IP, port của Web Server.
- Thư viện hỗ trợ lấy dữ liệu của DHT11. Dựa theo chuẩn truyền nhận 1 wire và sự phổ biến của dòng sensor DHTXX (DHT11, DHT22,...), có rất nhiều thư viện được xây dựng lên để việc lập trình với DHT11 trở nên dễ dàng hơn. Trong bài này chúng ta sẽ cài đặt và sử dụng thư viện `DHT sensor library` của Adafruit

.Hình ảnh thư viện DHT sensor library
image::04-dht11/install-lib.png[height=900, scaledwidth="75%", align="center"]

**Mã nguồn ESP8266**

[source, c]
----
include::code/dht11-logger/dht11-logger.ino[]
----

**Giải thích mã nguồn**

Import các thư viện cần sử dụng và các khai báo liên quan

----
#include <DHT.h>            // khai báo sử dụng thư viện DHT
#include <ESP8266WiFi.h>    // include thư viện WiFi cho sketch
#define DHTPIN 4            // Khai báo chân tín hiệu của DHT11
#define DHTTYPE DHT11       // Loại DHT được sử dụng

DHT dht(DHTPIN, DHTTYPE);
WiFiClient client;          // Tạo 1 biến client thuộc kiểu WiFiClient
----

Khởi tạo các thông số liên quan đến kết nối WiFi và kết nối server

----
const char* ssid = "YOUR-WIFI-SSID";     // Tên WiFi (SSID) sẽ kết nối
const char* password = "YOUR-WIFI-PASS"; // Password của WiFi sẽ kết nối
const char* server = "192.168.1.100";    // Địa chỉ IP của máy khi truy cập cùng mạng WiFi
const int port = 8000;                   // Port của server đã mở
const int sendingInternval = 2 * 1000;   // Gửi dữ liệu lên server sau mỗi 2s
----

Khởi tạo serial, DHT11, và kết nối đến mạng WiFi đã thiết lập
----
Serial.begin(115200);
dht.begin();
Serial.println("Connecting");
WiFi.begin(ssid, password);
while (WiFi.status() != WL_CONNECTED) {
  Serial.print(".");
  delay(100);
}
Serial.println("\r\nWiFi connected");
----

Lấy dữ liệu từ DHT11

----
float temp = dht.readTemperature(); // Lấy dữ liệu nhiệt độ (độ C)
float humi = dht.readHumidity();    // Lấy dữ liệu độ ẩm
if (isnan(temp) || isnan(humi)) {   // Kiểm tra nếu dữ liệu không phải là số sẽ đọc lại giá trị
  Serial.println("Failed to read from DHT sensor!");
  return;
}
----

Thiết lập kết nối đến server và gửi dữ liệu

----
if (client.connect(server, port)) { //Kiểm tra kết nối đến IP của máy tính và port
// Gửi dữ liệu temp và humd lên server thông qua URL sử dụng phương thức GET
// Phía server sẽ xử lí URL của ESP8266 gửi lên để lấy dữ liệu 
  String req_uri = "/update?temp=" + String(temp, 1) + "&humd=" + String(humi, 1);
  client.print("GET " + req_uri + "HTTP/1.1\n");
  client.print("Host: "+server+"\n");
  client.print("Connection: close\n");
  client.print("Content-Length: 0\n");
  client.print("\n\n");
  Serial.printf("Nhiet do %s - Do am %s\r\n", String(temp, 1).c_str(), String(humi, 1).c_str());
}
client.stop(); //Ngắt kết nối đến server
----


**Video kết quả**


=== Tổng kết
